{"config":{"lang":["en"],"prebuild_index":false,"separator":"[\\s\\-]+"},"docs":[{"location":"","text":"pod-webhooks \u00b6 This docker pod runs two services: Captain Hook webhook server (python + flask) b-captain-hook Static content server for subdomain pages (nginx) d-nginx-subdomains These two services are in this repo as submodules. Links \u00b6 See documentation page here: https://pages.charlesreid1.com/pod-webhooks Source code on git.charlesreid1.com: https://git.charlesreid1.com/docker/pod-webhooks Source code on github.com: https://github.com/charlesreid1-docker/pod-webhooks Initial Setup of Pages Subdomain \u00b6 The pages.charlesreid1.com subdomain is served from content in the directory /www/pages.charlesreid1.com . To set this up with pages and sites that should exist already, use the set up script at scripts/pages_init_setup.py and run it on the pages.charlesreid1.com server: python scripts/pages_init_setup.py This will create the /www/pages.charlesreid1.com/ directory structure and will clone several repositories to populate it with content. Adding Hooks \u00b6 Since this is probably the only thing you'll care about once everything is actually running... until it breaks. How To Add A Hook How It Works \u00b6 See Running.md for info about running this docker pod. Running the Docker Pod from Comand Line Workflow for Docker Pod Updates See Services.md for info about running startup services. Running the Docker Pod as a Startup Service Running Captain Hook's Canary (Script) Enable/disable service (installs/uninstalls, but does not start): sudo systemctl (enable|disable) pod-webhooks.service sudo systemctl (enable|disable) captain-hook-canary.service Start/stop: sudo systemctl (start|stop) pod-webhooks.service sudo systemctl (start|stop) captain-hook-canary.service See Captain Hook's Canary for details on the canary script that allows the webhooks docker pod to trigger itself to be re-loaded when there are new hooks added to captain hook. Volumes and Files \u00b6 Subdomains \u00b6 The static files hosted on charlesreid1.com subdomains are contained in subdirectories of /www/*.charlesreid1.com/ and this is mounted by the subdomains docker container that has rules set up for which subdomains to serve. Captain Hook \u00b6 Captain Hook mounts the /www folder, which is served by the subdomains nginx server, as well as the hooks folder in the Captain Hook repository (that's at b-captain-hook/hooks ). When there is a change pushed to a particular branch on git.charlesreid1.com, the git.charlesreid1.com server will check if there is a corresponding hook that's been added to Captain Hook for that repo and branch. If so, git.charlesreid1.com runs that script. For pages.charlesreid1.com, that's usually just a git pull on the contents of /www/pages.charlesreid1.com/my-page . Captain Hook's Canary \u00b6 Captain Hook presents a bit of a paradox: what happens when Captain Hook installs a hook for itself, and detects that Captain Hook itself has changed? In this case, the webhooks docker pod needs to be able to tell the host machine to restart the webhooks docker pod. This is done by Captain Hook's Canary. This is a service script that checks every 10 seconds for a trigger file in a directory mounted between the host and container. If the trigger file is present, the host will update its copy of Captain Hook, then restart the webhooks-subdomains docker pod. As per the dotfiles/debian repo, the captain_hook_canary.sh canary will restart the webhooks docker pod if it detects the presence following file: /tmp/triggers/push-b-captain-hook-master (The canary script will remove this file once it has restarted the webhooks docker pod.) Now, a hook can be added to Captain Hook that will be run when there is a push event on the master branch of bots/b-captain-hook . By creating a hook named push-b-captain-hook-master in the hooks/ directory of Captain Hook, and having it simply run touch /tmp/triggers/push-b-captain-hook-master , this webhook can trigger the Captain Hook's Canary service script, which triggers a restart of the webhooks docker pod. Code: https://git.charlesreid1.com/bots/b-captain-hook/src/branch/master/hooks/push-b-captain-hook-master Network \u00b6 The d-subodomains-nginx container opens different ports for different subdomains, and reverse-proxies requests from charlesreid1.com. The port numbering starts at 7777 for pages.charlesreid1.com and goes up from there, one port per subdomain. Also see pod-charlesreid1 on git.charlesreid1.com for the nginx reverse proxy configuration. Captain Hook runs a Flask server on port 5000 and listens for triggers from git.charlesreid1.com (gitea) web hooks. These web hooks must have the correct secret or the trigger will be ignored. Servers \u00b6 pod-webhooks runs on a virtual server somewhere. This pod's nginx service provides a backend that is reverse-proxied by the machine running pod-charlesreid1 (and the whole https://charlesreid1.com frontend). It opens ports 7777+ and up (one per subdomain). The pod-charlesreid1 docker pod (actually the d-nginx-charlesreid1 submodule in that pod) contains the nginx config files that control the reverse proxy behavior of https://charlesreid1.com . Like the nginx service in this webhooks pod, the Captain Hook webhook service is also reverse-proxied by the main nginx frontend running https://charlesreid1.com with the pod-charlesreid1 docker pod. If a URL request for https://hooks.charlesreid1.com is received by the https://charlesreid1.com server, it is forwarded to the machine running the pod-webhooks docker pod, which decides whether it is a POST request (that should be sent to this pod's Captain Hook) or a GET request (that should be sent to this pod's nginx).","title":"Home"},{"location":"#pod-webhooks","text":"This docker pod runs two services: Captain Hook webhook server (python + flask) b-captain-hook Static content server for subdomain pages (nginx) d-nginx-subdomains These two services are in this repo as submodules.","title":"pod-webhooks"},{"location":"#links","text":"See documentation page here: https://pages.charlesreid1.com/pod-webhooks Source code on git.charlesreid1.com: https://git.charlesreid1.com/docker/pod-webhooks Source code on github.com: https://github.com/charlesreid1-docker/pod-webhooks","title":"Links"},{"location":"#initial-setup-of-pages-subdomain","text":"The pages.charlesreid1.com subdomain is served from content in the directory /www/pages.charlesreid1.com . To set this up with pages and sites that should exist already, use the set up script at scripts/pages_init_setup.py and run it on the pages.charlesreid1.com server: python scripts/pages_init_setup.py This will create the /www/pages.charlesreid1.com/ directory structure and will clone several repositories to populate it with content.","title":"Initial Setup of Pages Subdomain"},{"location":"#adding-hooks","text":"Since this is probably the only thing you'll care about once everything is actually running... until it breaks. How To Add A Hook","title":"Adding Hooks"},{"location":"#how-it-works","text":"See Running.md for info about running this docker pod. Running the Docker Pod from Comand Line Workflow for Docker Pod Updates See Services.md for info about running startup services. Running the Docker Pod as a Startup Service Running Captain Hook's Canary (Script) Enable/disable service (installs/uninstalls, but does not start): sudo systemctl (enable|disable) pod-webhooks.service sudo systemctl (enable|disable) captain-hook-canary.service Start/stop: sudo systemctl (start|stop) pod-webhooks.service sudo systemctl (start|stop) captain-hook-canary.service See Captain Hook's Canary for details on the canary script that allows the webhooks docker pod to trigger itself to be re-loaded when there are new hooks added to captain hook.","title":"How It Works"},{"location":"#volumes-and-files","text":"","title":"Volumes and Files"},{"location":"#subdomains","text":"The static files hosted on charlesreid1.com subdomains are contained in subdirectories of /www/*.charlesreid1.com/ and this is mounted by the subdomains docker container that has rules set up for which subdomains to serve.","title":"Subdomains"},{"location":"#captain-hook","text":"Captain Hook mounts the /www folder, which is served by the subdomains nginx server, as well as the hooks folder in the Captain Hook repository (that's at b-captain-hook/hooks ). When there is a change pushed to a particular branch on git.charlesreid1.com, the git.charlesreid1.com server will check if there is a corresponding hook that's been added to Captain Hook for that repo and branch. If so, git.charlesreid1.com runs that script. For pages.charlesreid1.com, that's usually just a git pull on the contents of /www/pages.charlesreid1.com/my-page .","title":"Captain Hook"},{"location":"#captain-hooks-canary","text":"Captain Hook presents a bit of a paradox: what happens when Captain Hook installs a hook for itself, and detects that Captain Hook itself has changed? In this case, the webhooks docker pod needs to be able to tell the host machine to restart the webhooks docker pod. This is done by Captain Hook's Canary. This is a service script that checks every 10 seconds for a trigger file in a directory mounted between the host and container. If the trigger file is present, the host will update its copy of Captain Hook, then restart the webhooks-subdomains docker pod. As per the dotfiles/debian repo, the captain_hook_canary.sh canary will restart the webhooks docker pod if it detects the presence following file: /tmp/triggers/push-b-captain-hook-master (The canary script will remove this file once it has restarted the webhooks docker pod.) Now, a hook can be added to Captain Hook that will be run when there is a push event on the master branch of bots/b-captain-hook . By creating a hook named push-b-captain-hook-master in the hooks/ directory of Captain Hook, and having it simply run touch /tmp/triggers/push-b-captain-hook-master , this webhook can trigger the Captain Hook's Canary service script, which triggers a restart of the webhooks docker pod. Code: https://git.charlesreid1.com/bots/b-captain-hook/src/branch/master/hooks/push-b-captain-hook-master","title":"Captain Hook's Canary"},{"location":"#network","text":"The d-subodomains-nginx container opens different ports for different subdomains, and reverse-proxies requests from charlesreid1.com. The port numbering starts at 7777 for pages.charlesreid1.com and goes up from there, one port per subdomain. Also see pod-charlesreid1 on git.charlesreid1.com for the nginx reverse proxy configuration. Captain Hook runs a Flask server on port 5000 and listens for triggers from git.charlesreid1.com (gitea) web hooks. These web hooks must have the correct secret or the trigger will be ignored.","title":"Network"},{"location":"#servers","text":"pod-webhooks runs on a virtual server somewhere. This pod's nginx service provides a backend that is reverse-proxied by the machine running pod-charlesreid1 (and the whole https://charlesreid1.com frontend). It opens ports 7777+ and up (one per subdomain). The pod-charlesreid1 docker pod (actually the d-nginx-charlesreid1 submodule in that pod) contains the nginx config files that control the reverse proxy behavior of https://charlesreid1.com . Like the nginx service in this webhooks pod, the Captain Hook webhook service is also reverse-proxied by the main nginx frontend running https://charlesreid1.com with the pod-charlesreid1 docker pod. If a URL request for https://hooks.charlesreid1.com is received by the https://charlesreid1.com server, it is forwarded to the machine running the pod-webhooks docker pod, which decides whether it is a POST request (that should be sent to this pod's Captain Hook) or a GET request (that should be sent to this pod's nginx).","title":"Servers"},{"location":"adding/","text":"Adding New Hooks \u00b6 To add a hook to Captain Hook: Create an executable script in bots/b-captain-hook on git.charlesreid1.com with the name of the action, the name of the repo (not the owner), and the name of the branch in the filename. For example, push-my-dotfiles-master would be matched every time I push changes to the master branch of any repository named my-dotfiles . Add, commit, and push your hook to the master branch of Captain Hook Wait about 15 seconds for the canary script to run (it has to update the Captain Hook git repo running on the remote server to the latest version and restart the webhooks-subdomains docker pod.) Open the my-dotfiles repository on git.charlesreid1.com, go to the Settings > Webhooks page, and add a Gitea webhook. Enter info: a. Payload URL is the Captain Hook server, which is https://hooks.charlesreid1.com/webhook . b. Content type is application/json c. Secret is (that's my little secret) d. Pick what events you would like to trigger webhooks, usually \"just the push event\" Save the webhook, then click on the webhook again to open it back up. Scroll down to the bottom right and click \"Test Delivery\". You should see a green success sign. Debugging Failed Hooks \u00b6 If you see a red warning sign: Ensure the webhooks docker pod is actually running okay ( docker ps on the host machine) Ensure port 5000 is open in the Captain Hook container, and on the host machine Ensure you can see port 5000 of the pod-webhooks host machine from the pod-charlesreid1 host machine Ensure there is actually a hook in the hooks/ directory of the Captain Hook repo Captain Hook repo: https://git.charlesreid1.com/bots/b-captain-hook Captain Hook repo (Github mirror): https://github.com/charlesreid1-docker/b-captain-hook","title":"Adding Webhooks"},{"location":"adding/#adding-new-hooks","text":"To add a hook to Captain Hook: Create an executable script in bots/b-captain-hook on git.charlesreid1.com with the name of the action, the name of the repo (not the owner), and the name of the branch in the filename. For example, push-my-dotfiles-master would be matched every time I push changes to the master branch of any repository named my-dotfiles . Add, commit, and push your hook to the master branch of Captain Hook Wait about 15 seconds for the canary script to run (it has to update the Captain Hook git repo running on the remote server to the latest version and restart the webhooks-subdomains docker pod.) Open the my-dotfiles repository on git.charlesreid1.com, go to the Settings > Webhooks page, and add a Gitea webhook. Enter info: a. Payload URL is the Captain Hook server, which is https://hooks.charlesreid1.com/webhook . b. Content type is application/json c. Secret is (that's my little secret) d. Pick what events you would like to trigger webhooks, usually \"just the push event\" Save the webhook, then click on the webhook again to open it back up. Scroll down to the bottom right and click \"Test Delivery\". You should see a green success sign.","title":"Adding New Hooks"},{"location":"adding/#debugging-failed-hooks","text":"If you see a red warning sign: Ensure the webhooks docker pod is actually running okay ( docker ps on the host machine) Ensure port 5000 is open in the Captain Hook container, and on the host machine Ensure you can see port 5000 of the pod-webhooks host machine from the pod-charlesreid1 host machine Ensure there is actually a hook in the hooks/ directory of the Captain Hook repo Captain Hook repo: https://git.charlesreid1.com/bots/b-captain-hook Captain Hook repo (Github mirror): https://github.com/charlesreid1-docker/b-captain-hook","title":"Debugging Failed Hooks"},{"location":"canary/","text":"Captain Hook's Canary \u00b6 First things first: Captain Hook is the webhook server that is part of the webhooks docker pod. It receives webhooks from Github and Gitea and uses them to trigger scrips. Links to documentation and code for Captain Hook. Captain Hook's Canary is a mechanism by which the Captain Hook webhooks server (running in a docker container) can trigger an action on the host machine (running the pod). In this case the action is to update Captain Hook and restart the docker pod anytime a webhook is received indicating the Captain Hook repo has changed. This is done by bind-mounting a host directory at /tmp/triggers/ inside the Captain Hook docker container. When Captain Hook receives a webhook from Github or Gitea that indicates the Captain Hook repo ( https://git.charlesreid1.com/bots/b-captain-hook or https://github.com/charlesreid1/captain-hook ), it creates a trigger file. Meanwhile, on the host that is running the docker pod, a service script is running continuously to check for that trigger file every 10 seconds. If the trigger file is seen, it updates the Captain Hook git repository on the host machine and then restarts the docker pod. Sections below cover the following scripts, all run on the host: The canary bash script The docker host pull script The canary statup service The Canary Bash Script \u00b6 Note: this needs an associated systemd service. See the services directory of the dotfiles repo. This is a canary script for connecting the Captain Hook container to the host machine, and triggering tasks on the host machine with webhooks. The Captain Hook container mounts the following host directory inside the container (same location for host/container): /tmp/triggers/ When a webhook in Captain Hook wants to trigger an event on the host (blackbeard), it puts a file in /tmp/triggers/ . Meanwhile, on the host, this script checks every 10 seconds for trigger files. Each webhook can create its own trigger file, and this script processes each trigger differently. #!/bin/bash TRIGGER = \"/tmp/triggers/push-b-captain-hook-master\" UPDATE_SCRIPT = \" ${ HOME } /pod-webhooks/scripts/captain_hook_pull_host.py\" while true do # bootstrap-pull captain hook if [ -f \" $TRIGGER \" ] ; then echo \"CAPTAIN HOOK'S CANARY:\" echo \"Running trigger to update Captain Hook on the host machine (user charles)\" sudo -H -u charles python $UPDATE_SCRIPT echo \"All done.\" rm -f ${ TRIGGER } fi sleep 10 ; done The Pull Host Captain Hook Script \u00b6 Next we have a python script that actually updates the host's version of Captain Hook: #!/usr/bin/env python3 import subprocess import os import time \"\"\" Captain Hook: Pull Captain Hook on the Host This script is called by the host machine (blackbeard) running the Captain Hook container. This is triggered by push actions to the master branch of b-captain-hook. The action is to update (git pull) the copy of Captain Hook running on the host, and restart the container pod. \"\"\" work_dir = os . path . join ( '/home' , 'charles' , 'pod-webhooks' , 'b-captain-hook' ) # Step 1: # Update Captain Hook pull_cmd = [ 'git' , 'pull' , 'origin' , 'master' ] subprocess . call ( pull_cmd , cwd = work_dir ) time . sleep ( 5 ) # Step 2: # Restart Captain Hook pod pod_restart = [ 'docker-compose' , 'restart' ] subprocess . call ( pod_restart , cwd = work_dir ) The Canary Startup Script \u00b6 Here is the startup file that runs the Captain Hook's Canary bash script. The stop directive uses pgrep to find the process id and stops any PIDs returned. [Unit] Description=captain hook canary script Requires=pod-webhooks.service After=pod-webhooks.service [Service] Restart=always ExecStart=/home/charles/pod-webhooks/scripts/captain_hook_canary.sh ExecStop=/usr/bin/pgrep -f captain_hook_canary | /usr/bin/xargs /bin/kill [Install] WantedBy=default.target See Services for more info on what to do with this file.","title":"Captain Hook's Canary"},{"location":"canary/#captain-hooks-canary","text":"First things first: Captain Hook is the webhook server that is part of the webhooks docker pod. It receives webhooks from Github and Gitea and uses them to trigger scrips. Links to documentation and code for Captain Hook. Captain Hook's Canary is a mechanism by which the Captain Hook webhooks server (running in a docker container) can trigger an action on the host machine (running the pod). In this case the action is to update Captain Hook and restart the docker pod anytime a webhook is received indicating the Captain Hook repo has changed. This is done by bind-mounting a host directory at /tmp/triggers/ inside the Captain Hook docker container. When Captain Hook receives a webhook from Github or Gitea that indicates the Captain Hook repo ( https://git.charlesreid1.com/bots/b-captain-hook or https://github.com/charlesreid1/captain-hook ), it creates a trigger file. Meanwhile, on the host that is running the docker pod, a service script is running continuously to check for that trigger file every 10 seconds. If the trigger file is seen, it updates the Captain Hook git repository on the host machine and then restarts the docker pod. Sections below cover the following scripts, all run on the host: The canary bash script The docker host pull script The canary statup service","title":"Captain Hook's Canary"},{"location":"canary/#the-canary-bash-script","text":"Note: this needs an associated systemd service. See the services directory of the dotfiles repo. This is a canary script for connecting the Captain Hook container to the host machine, and triggering tasks on the host machine with webhooks. The Captain Hook container mounts the following host directory inside the container (same location for host/container): /tmp/triggers/ When a webhook in Captain Hook wants to trigger an event on the host (blackbeard), it puts a file in /tmp/triggers/ . Meanwhile, on the host, this script checks every 10 seconds for trigger files. Each webhook can create its own trigger file, and this script processes each trigger differently. #!/bin/bash TRIGGER = \"/tmp/triggers/push-b-captain-hook-master\" UPDATE_SCRIPT = \" ${ HOME } /pod-webhooks/scripts/captain_hook_pull_host.py\" while true do # bootstrap-pull captain hook if [ -f \" $TRIGGER \" ] ; then echo \"CAPTAIN HOOK'S CANARY:\" echo \"Running trigger to update Captain Hook on the host machine (user charles)\" sudo -H -u charles python $UPDATE_SCRIPT echo \"All done.\" rm -f ${ TRIGGER } fi sleep 10 ; done","title":"The Canary Bash Script"},{"location":"canary/#the-pull-host-captain-hook-script","text":"Next we have a python script that actually updates the host's version of Captain Hook: #!/usr/bin/env python3 import subprocess import os import time \"\"\" Captain Hook: Pull Captain Hook on the Host This script is called by the host machine (blackbeard) running the Captain Hook container. This is triggered by push actions to the master branch of b-captain-hook. The action is to update (git pull) the copy of Captain Hook running on the host, and restart the container pod. \"\"\" work_dir = os . path . join ( '/home' , 'charles' , 'pod-webhooks' , 'b-captain-hook' ) # Step 1: # Update Captain Hook pull_cmd = [ 'git' , 'pull' , 'origin' , 'master' ] subprocess . call ( pull_cmd , cwd = work_dir ) time . sleep ( 5 ) # Step 2: # Restart Captain Hook pod pod_restart = [ 'docker-compose' , 'restart' ] subprocess . call ( pod_restart , cwd = work_dir )","title":"The Pull Host Captain Hook Script"},{"location":"canary/#the-canary-startup-script","text":"Here is the startup file that runs the Captain Hook's Canary bash script. The stop directive uses pgrep to find the process id and stops any PIDs returned. [Unit] Description=captain hook canary script Requires=pod-webhooks.service After=pod-webhooks.service [Service] Restart=always ExecStart=/home/charles/pod-webhooks/scripts/captain_hook_canary.sh ExecStop=/usr/bin/pgrep -f captain_hook_canary | /usr/bin/xargs /bin/kill [Install] WantedBy=default.target See Services for more info on what to do with this file.","title":"The Canary Startup Script"},{"location":"running/","text":"The Docker Compose File \u00b6 The docker-compose.yml file contains everything needed to run the webhooks docker pod: a Captain Hook webhook server, and an nginx server to serve up static pages for each subdomain. Why use docker-compose instead of docker? docker-compose is the preferred way to run multiple containers. Running Webhooks Docker Pod from Command Line \u00b6 Run the pod in the foreground or background by running these commands from the directory containing docker-compose.yml : docker-compose up # interactive docker-compose up -d # detached If you want to rebuild all the containers before bringing the pod up, add the --build flag: docker-compose up --build If you just want to rebuild the containers without bringing them up, docker-compose build To rebuild absolutely everything from scratch, docker-compose build --no-cache WARNING: this will re-download all aptitude packages, which can be extremely slow. Use with caution. You can restart all containers in a pod using the restart command: docker-compose restart WARNING: this will NOT pick up changes to Dockerfiles or to files that are mounted into the container. This simply restarts the container using the same image (in memory) that was previously running, without getting an up-to-date container image. Workflow for Docker Pod Updates \u00b6 To minimize downtime, use the following workflow: Run docker-compose build to rebuild the images, leaving the pod running (they are not affected) Run docker-compose down to bring the pod down Run docker-compose up to bring the pod up (Add the -d flag to start the docker pod in the background.)","title":"Running Captain Hook"},{"location":"running/#the-docker-compose-file","text":"The docker-compose.yml file contains everything needed to run the webhooks docker pod: a Captain Hook webhook server, and an nginx server to serve up static pages for each subdomain. Why use docker-compose instead of docker? docker-compose is the preferred way to run multiple containers.","title":"The Docker Compose File"},{"location":"running/#running-webhooks-docker-pod-from-command-line","text":"Run the pod in the foreground or background by running these commands from the directory containing docker-compose.yml : docker-compose up # interactive docker-compose up -d # detached If you want to rebuild all the containers before bringing the pod up, add the --build flag: docker-compose up --build If you just want to rebuild the containers without bringing them up, docker-compose build To rebuild absolutely everything from scratch, docker-compose build --no-cache WARNING: this will re-download all aptitude packages, which can be extremely slow. Use with caution. You can restart all containers in a pod using the restart command: docker-compose restart WARNING: this will NOT pick up changes to Dockerfiles or to files that are mounted into the container. This simply restarts the container using the same image (in memory) that was previously running, without getting an up-to-date container image.","title":"Running Webhooks Docker Pod from Command Line"},{"location":"running/#workflow-for-docker-pod-updates","text":"To minimize downtime, use the following workflow: Run docker-compose build to rebuild the images, leaving the pod running (they are not affected) Run docker-compose down to bring the pod down Run docker-compose up to bring the pod up (Add the -d flag to start the docker pod in the background.)","title":"Workflow for Docker Pod Updates"},{"location":"services/","text":"Running Hooks-Subdomains Docker Pod as Startup Service \u00b6 The webhooks-subdomains docker pod requires two startup services: Docker pod service - this startup service keeps the pod running, and will restart it if it crashes Captain Hook's canary - this watches a folder that is shared between the docker pod host and the Captain Hook container, which allows the pod to send triggers to the host. Also see the scripts/ folder of this repo, pod-webhooks ( Github mirror ). Docker Pod Startup Service \u00b6 This service keeps the webhooks docker pod service running continuously. If the pod stops, this service will restart it. (This service should not be running if you are troubleshooting the docker pod, otherwise every time you try and stop the pod it will respawn.) pod-webhooks.service: [Unit] Description=webhooks and subdomains docker pod Requires=docker.service After=docker.service [Service] Restart=always ExecStart=/usr/local/bin/docker-compose -f /home/charles/codes/docker/pod-webhooks/docker-compose.yml up ExecStop=/usr/local/bin/docker-compose -f /home/charles/codes/docker/pod-webhooks/docker-compose.yml down [Install] WantedBy=default.target Captain Hook's Canary Startup Service \u00b6 This service just watches a folder for a particular watchfile, and runs a script if it sees the watchfile appear. captain-hook-canary.service: [Unit] Description=captain hook canary script Requires=pod-webhooks.service After=pod-webhooks.service [Service] Restart=always ExecStart=/home/charles/pod-webhooks/scripts/captain_hook_canary.sh ExecStop=/usr/bin/pgrep -f captain_hook_canary | /usr/bin/xargs /bin/kill [Install] WantedBy=default.target Installing Services \u00b6 Install the services by copying the *.service files to /etc/systemd/system/dockerpod-webhooks.servce and /etc/systemd/system/captain-hook-canary.servce , and activate the startup services: sudo systemctl enable pod-webhooks.service sudo systemctl enable captain-hook-canary.service Now you can start/stop the services with: sudo systemctl (start|stop) pod-webhooks.service sudo systemctl (start|stop) captain-hook-canary.service As mentioned above, these services should be stopped before doing a docker-compose stop or a docker-compose up --build to keep the pod from respawning in the middle of the task.","title":"Captain Hook Startup Services"},{"location":"services/#running-hooks-subdomains-docker-pod-as-startup-service","text":"The webhooks-subdomains docker pod requires two startup services: Docker pod service - this startup service keeps the pod running, and will restart it if it crashes Captain Hook's canary - this watches a folder that is shared between the docker pod host and the Captain Hook container, which allows the pod to send triggers to the host. Also see the scripts/ folder of this repo, pod-webhooks ( Github mirror ).","title":"Running Hooks-Subdomains Docker Pod as Startup Service"},{"location":"services/#docker-pod-startup-service","text":"This service keeps the webhooks docker pod service running continuously. If the pod stops, this service will restart it. (This service should not be running if you are troubleshooting the docker pod, otherwise every time you try and stop the pod it will respawn.) pod-webhooks.service: [Unit] Description=webhooks and subdomains docker pod Requires=docker.service After=docker.service [Service] Restart=always ExecStart=/usr/local/bin/docker-compose -f /home/charles/codes/docker/pod-webhooks/docker-compose.yml up ExecStop=/usr/local/bin/docker-compose -f /home/charles/codes/docker/pod-webhooks/docker-compose.yml down [Install] WantedBy=default.target","title":"Docker Pod Startup Service"},{"location":"services/#captain-hooks-canary-startup-service","text":"This service just watches a folder for a particular watchfile, and runs a script if it sees the watchfile appear. captain-hook-canary.service: [Unit] Description=captain hook canary script Requires=pod-webhooks.service After=pod-webhooks.service [Service] Restart=always ExecStart=/home/charles/pod-webhooks/scripts/captain_hook_canary.sh ExecStop=/usr/bin/pgrep -f captain_hook_canary | /usr/bin/xargs /bin/kill [Install] WantedBy=default.target","title":"Captain Hook's Canary Startup Service"},{"location":"services/#installing-services","text":"Install the services by copying the *.service files to /etc/systemd/system/dockerpod-webhooks.servce and /etc/systemd/system/captain-hook-canary.servce , and activate the startup services: sudo systemctl enable pod-webhooks.service sudo systemctl enable captain-hook-canary.service Now you can start/stop the services with: sudo systemctl (start|stop) pod-webhooks.service sudo systemctl (start|stop) captain-hook-canary.service As mentioned above, these services should be stopped before doing a docker-compose stop or a docker-compose up --build to keep the pod from respawning in the middle of the task.","title":"Installing Services"}]}