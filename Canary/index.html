



<!DOCTYPE html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      <meta http-equiv="x-ua-compatible" content="ie=edge">
      
      
        <link rel="canonical" href="https://pages.charlesreid1.com/pod-webhooks/canary/">
      
      
      
        <meta name="lang:clipboard.copy" content="Copy to clipboard">
      
        <meta name="lang:clipboard.copied" content="Copied to clipboard">
      
        <meta name="lang:search.language" content="en">
      
        <meta name="lang:search.pipeline.stopwords" content="True">
      
        <meta name="lang:search.pipeline.trimmer" content="True">
      
        <meta name="lang:search.result.none" content="No matching documents">
      
        <meta name="lang:search.result.one" content="1 matching document">
      
        <meta name="lang:search.result.other" content="# matching documents">
      
        <meta name="lang:search.tokenizer" content="[\s\-]+">
      
      <link rel="shortcut icon" href="..">
      <meta name="generator" content="mkdocs-1.0.4, mkdocs-material-3.0.3">
    
    
      
        <title>Captain Hook's Canary - pod-webhooks</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/application.451f80e5.css">
      
        <link rel="stylesheet" href="../assets/stylesheets/application-palette.22915126.css">
      
      
        
        
        <meta name="theme-color" content="#2196f3">
      
    
    
      <script src="../assets/javascripts/modernizr.1aa3b519.js"></script>
    
    
      <link href="https://fonts.gstatic.com" rel="preconnect" crossorigin>
      
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700|Roboto+Mono">
        <style>body,input{font-family:"Roboto","Helvetica Neue",Helvetica,Arial,sans-serif}code,kbd,pre{font-family:"Roboto Mono","Courier New",Courier,monospace}</style>
      
    
    <link rel="stylesheet" href="../assets/fonts/material-icons.css">
    
      <link rel="stylesheet" href="../css/custom.css">
    
    
  </head>
  
    
    
    <body dir="ltr" data-md-color-primary="blue" data-md-color-accent="blue">
  
    <svg class="md-svg">
      <defs>
        
        
      </defs>
    </svg>
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" data-md-component="overlay" for="__drawer"></label>
    
      <a href="../#captain-hooks-canary" tabindex="1" class="md-skip">
        Skip to content
      </a>
    
    
      <header class="md-header" data-md-component="header">
  <nav class="md-header-nav md-grid">
    <div class="md-flex">
      <div class="md-flex__cell md-flex__cell--shrink">
        <a href="https://pages.charlesreid1.com/pod-webhooks" title="pod-webhooks" class="md-header-nav__button md-logo">
          
            <i class="md-icon">dns</i>
          
        </a>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        <label class="md-icon md-icon--menu md-header-nav__button" for="__drawer"></label>
      </div>
      <div class="md-flex__cell md-flex__cell--stretch">
        <div class="md-flex__ellipsis md-header-nav__title" data-md-component="title">
          
            
              <span class="md-header-nav__topic">
                pod-webhooks
              </span>
              <span class="md-header-nav__topic">
                Captain Hook's Canary
              </span>
            
          
        </div>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        
          
            <label class="md-icon md-icon--search md-header-nav__button" for="__search"></label>
            
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="query" data-md-state="active">
      <label class="md-icon md-search__icon" for="__search"></label>
      <button type="reset" class="md-icon md-search__icon" data-md-component="reset" tabindex="-1">
        &#xE5CD;
      </button>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="result">
          <div class="md-search-result__meta">
            Type to start searching
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
          
        
      </div>
      
        <div class="md-flex__cell md-flex__cell--shrink">
          <div class="md-header-nav__source">
            


  


  <a href="https://git.charlesreid1.com/docker/pod-webhooks" title="Go to repository" class="md-source" data-md-source="">
    
    <div class="md-source__repository">
      pod-webhooks
    </div>
  </a>

          </div>
        </div>
      
    </div>
  </nav>
</header>
    
    <div class="md-container">
      
        
      
      <main class="md-main">
        <div class="md-main__inner md-grid" data-md-component="container">
          
            
              <div class="md-sidebar md-sidebar--primary" data-md-component="navigation">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    <nav class="md-nav md-nav--primary" data-md-level="0">
  <label class="md-nav__title md-nav__title--site" for="__drawer">
    <a href="https://pages.charlesreid1.com/pod-webhooks" title="pod-webhooks" class="md-nav__button md-logo">
      
        <i class="md-icon">dns</i>
      
    </a>
    pod-webhooks
  </label>
  
    <div class="md-nav__source">
      


  


  <a href="https://git.charlesreid1.com/docker/pod-webhooks" title="Go to repository" class="md-source" data-md-source="">
    
    <div class="md-source__repository">
      pod-webhooks
    </div>
  </a>

    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      


  <li class="md-nav__item">
    <a href=".." title="Home" class="md-nav__link">
      Home
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../adding/" title="Adding Webhooks" class="md-nav__link">
      Adding Webhooks
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../running/" title="Running Captain Hook" class="md-nav__link">
      Running Captain Hook
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../services/" title="Captain Hook Startup Services" class="md-nav__link">
      Captain Hook Startup Services
    </a>
  </li>

    
      
      
      

  


  <li class="md-nav__item md-nav__item--active">
    
    <input class="md-toggle md-nav__toggle" data-md-toggle="toc" type="checkbox" id="__toc">
    
      
    
    
      <label class="md-nav__link md-nav__link--active" for="__toc">
        Captain Hook's Canary
      </label>
    
    <a href="./" title="Captain Hook's Canary" class="md-nav__link md-nav__link--active">
      Captain Hook's Canary
    </a>
    
      
<nav class="md-nav md-nav--secondary">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">Table of contents</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#the-canary-bash-script" title="The Canary Bash Script" class="md-nav__link">
    The Canary Bash Script
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#the-pull-host-captain-hook-script" title="The Pull Host Captain Hook Script" class="md-nav__link">
    The Pull Host Captain Hook Script
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#the-canary-startup-script" title="The Canary Startup Script" class="md-nav__link">
    The Canary Startup Script
  </a>
  
</li>
      
      
      
      
      
    </ul>
  
</nav>
    
  </li>

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              <div class="md-sidebar md-sidebar--secondary" data-md-component="toc">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">Table of contents</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#the-canary-bash-script" title="The Canary Bash Script" class="md-nav__link">
    The Canary Bash Script
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#the-pull-host-captain-hook-script" title="The Pull Host Captain Hook Script" class="md-nav__link">
    The Pull Host Captain Hook Script
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#the-canary-startup-script" title="The Canary Startup Script" class="md-nav__link">
    The Canary Startup Script
  </a>
  
</li>
      
      
      
      
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content">
            <article class="md-content__inner md-typeset">
              
                
                
                <h1 id="captain-hooks-canary">Captain Hook's Canary<a class="headerlink" href="#captain-hooks-canary" title="Permanent link">&para;</a></h1>
<p>First things first: Captain Hook is the webhook server that
is part of the webhooks docker pod. It receives webhooks
from Github and Gitea and uses them to trigger scrips.
Links to <a href="https://pages.charlesreid1.com/b-captain-hook">documentation</a>
and <a href="https://git.charlesreid1.com/bots/b-captain-hook">code</a>
for Captain Hook.</p>
<p>Captain Hook's Canary is a mechanism by which the Captain Hook
webhooks server (running in a docker container) can trigger an action 
on the host machine (running the pod). In this case the action is to
update Captain Hook and restart the docker pod anytime a webhook is
received indicating the Captain Hook repo has changed.</p>
<p>This is done by bind-mounting a host directory at <code>/tmp/triggers/</code>
inside the Captain Hook docker container. When Captain Hook receives
a webhook from Github or Gitea that indicates the Captain Hook
repo (<a href="https://git.charlesreid1.com/bots/b-captain-hook">https://git.charlesreid1.com/bots/b-captain-hook</a> or
<a href="https://github.com/charlesreid1/captain-hook">https://github.com/charlesreid1/captain-hook</a>), it creates a
trigger file.</p>
<p>Meanwhile, on the host that is running the docker pod, a service 
script is running continuously to check for that trigger file
every 10 seconds. If the trigger file is seen, it updates the
Captain Hook git repository on the host machine and then restarts
the docker pod.</p>
<p>Sections below cover the following scripts, all run on the host:</p>
<ul>
<li>The canary bash script</li>
<li>The docker host pull script</li>
<li>The canary statup service</li>
</ul>
<h2 id="the-canary-bash-script">The Canary Bash Script<a class="headerlink" href="#the-canary-bash-script" title="Permanent link">&para;</a></h2>
<p>Note: this needs an associated systemd service.
See the services directory of the dotfiles repo.</p>
<p>This is a canary script for connecting
the Captain Hook container to the host 
machine, and triggering tasks on the 
host machine with webhooks.</p>
<p>The Captain Hook container mounts the 
following host directory inside the 
container (same location for host/container):</p>
<div class="codehilite"><pre><span></span>/tmp/triggers/
</pre></div>


<p>When a webhook in Captain Hook wants to 
trigger an event on the host (blackbeard),
it puts a file in <code>/tmp/triggers/</code>.</p>
<p>Meanwhile, on the host, this script checks
every 10 seconds for trigger files.</p>
<p>Each webhook can create its own trigger file,
and this script processes each trigger differently.</p>
<div class="codehilite"><pre><span></span><span class="ch">#!/bin/bash</span>

<span class="nv">TRIGGER</span><span class="o">=</span><span class="s2">&quot;/tmp/triggers/push-b-captain-hook-master&quot;</span>
<span class="nv">UPDATE_SCRIPT</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">HOME</span><span class="si">}</span><span class="s2">/pod-webhooks/scripts/captain_hook_pull_host.py&quot;</span>

<span class="k">while</span> <span class="nb">true</span>
<span class="k">do</span>
    <span class="c1"># bootstrap-pull captain hook</span>
    <span class="k">if</span> <span class="o">[</span> -f <span class="s2">&quot;</span><span class="nv">$TRIGGER</span><span class="s2">&quot;</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
        <span class="nb">echo</span> <span class="s2">&quot;CAPTAIN HOOK&#39;S CANARY:&quot;</span>
        <span class="nb">echo</span> <span class="s2">&quot;Running trigger to update Captain Hook on the host machine (user charles)&quot;</span>
        sudo -H -u charles python <span class="nv">$UPDATE_SCRIPT</span>
        <span class="nb">echo</span> <span class="s2">&quot;All done.&quot;</span>
        rm -f <span class="si">${</span><span class="nv">TRIGGER</span><span class="si">}</span>
    <span class="k">fi</span>

    sleep <span class="m">10</span><span class="p">;</span>
<span class="k">done</span>
</pre></div>


<h2 id="the-pull-host-captain-hook-script">The Pull Host Captain Hook Script<a class="headerlink" href="#the-pull-host-captain-hook-script" title="Permanent link">&para;</a></h2>
<p>Next we have a python script that actually updates the host's 
version of Captain Hook:</p>
<div class="codehilite"><pre><span></span><span class="ch">#!/usr/bin/env python3</span>
<span class="kn">import</span> <span class="nn">subprocess</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">time</span>

<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Captain Hook: Pull Captain Hook on the Host </span>

<span class="sd">This script is called by the host machine </span>
<span class="sd">(blackbeard) running the Captain Hook container.</span>

<span class="sd">This is triggered by push actions to the </span>
<span class="sd">master branch of b-captain-hook.</span>

<span class="sd">The action is to update (git pull) the copy </span>
<span class="sd">of Captain Hook running on the host, and</span>
<span class="sd">restart the container pod.</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="n">work_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s1">&#39;/home&#39;</span><span class="p">,</span><span class="s1">&#39;charles&#39;</span><span class="p">,</span><span class="s1">&#39;pod-webhooks&#39;</span><span class="p">,</span><span class="s1">&#39;b-captain-hook&#39;</span><span class="p">)</span>

<span class="c1"># Step 1:</span>
<span class="c1"># Update Captain Hook</span>
<span class="n">pull_cmd</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;git&#39;</span><span class="p">,</span><span class="s1">&#39;pull&#39;</span><span class="p">,</span><span class="s1">&#39;origin&#39;</span><span class="p">,</span><span class="s1">&#39;master&#39;</span><span class="p">]</span>
<span class="n">subprocess</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">pull_cmd</span><span class="p">,</span> <span class="n">cwd</span><span class="o">=</span><span class="n">work_dir</span><span class="p">)</span>

<span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>

<span class="c1"># Step 2:</span>
<span class="c1"># Restart Captain Hook pod</span>
<span class="n">pod_restart</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;docker-compose&#39;</span><span class="p">,</span><span class="s1">&#39;restart&#39;</span><span class="p">]</span>
<span class="n">subprocess</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">pod_restart</span><span class="p">,</span> <span class="n">cwd</span><span class="o">=</span><span class="n">work_dir</span><span class="p">)</span>
</pre></div>


<h2 id="the-canary-startup-script">The Canary Startup Script<a class="headerlink" href="#the-canary-startup-script" title="Permanent link">&para;</a></h2>
<p>Here is the startup file that runs the Captain Hook's Canary bash script.</p>
<p>The stop directive uses pgrep to find the process id and stops any PIDs returned.</p>
<div class="codehilite"><pre><span></span>[Unit]
Description=captain hook canary script
Requires=pod-webhooks.service
After=pod-webhooks.service

[Service]
Restart=always
ExecStart=/home/charles/pod-webhooks/scripts/captain_hook_canary.sh
ExecStop=/usr/bin/pgrep -f captain_hook_canary | /usr/bin/xargs /bin/kill 

[Install]
WantedBy=default.target
</pre></div>


<p>See <a href="../services/">Services</a> for more info on what to do with this file.</p>
                
                  
                
              
              
                


              
            </article>
          </div>
        </div>
      </main>
      
        
<footer class="md-footer">
  
    <div class="md-footer-nav">
      <nav class="md-footer-nav__inner md-grid">
        
          <a href="../services/" title="Captain Hook Startup Services" class="md-flex md-footer-nav__link md-footer-nav__link--prev" rel="prev">
            <div class="md-flex__cell md-flex__cell--shrink">
              <i class="md-icon md-icon--arrow-back md-footer-nav__button"></i>
            </div>
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
              <span class="md-flex__ellipsis">
                <span class="md-footer-nav__direction">
                  Previous
                </span>
                Captain Hook Startup Services
              </span>
            </div>
          </a>
        
        
      </nav>
    </div>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
          <div class="md-footer-copyright__highlight">
            Copyright &copy; 2018 <a href="https://charlesreid1.com">Charles Reid</a>, released under the <a href="https://opensource.org/licenses/MIT">MIT license</a>
          </div>
        
        powered by
        <a href="https://www.mkdocs.org">MkDocs</a>
        and
        <a href="https://squidfunk.github.io/mkdocs-material/">
          Material for MkDocs</a>
      </div>
      
        
      
    </div>
  </div>
</footer>
      
    </div>
    
      <script src="../assets/javascripts/application.e72fd936.js"></script>
      
      <script>app.initialize({version:"1.0.4",url:{base:".."}})</script>
      
        <script src="../search/main.js"></script>
      
    
    
      
    
  </body>
</html>